'use strict';

const WorkerStrategy = require('./lib/strategy/worker');
const AllStrategy = require('./lib/strategy/all');

module.exports = agent => {
  // don't redirect scheduleLogger
  agent.loggers.scheduleLogger.unredirect('error');

  // register built-in strategy
  // agent的schedule属性是本插件扩展出的。
  // schedule的type设置，一个worker跑还是全部。背后发的msg通知不同而已。
  agent.schedule.use('worker', WorkerStrategy);
  agent.schedule.use('all', AllStrategy);

  // wait for other plugin to register custom strategy
  agent.beforeStart(() => {
    agent.schedule.init();
  });

  agent.messenger.once('egg-ready', () => {
    // start schedule after worker ready
    // 根据该schedule的type设置，跑不同实例的start。all/worker
    agent.schedule.start();
  });
};
